# Windows ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ»30 äººåŒæ™‚æŽ¥ç¶šå¯¾å¿œã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025å¹´12æœˆ2æ—¥  
**å¯¾è±¡**: ScienceBuddy ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ•™å¸«ç”¨ PCã€WiFi æŽ¥ç¶šç’°å¢ƒï¼‰

---

## ðŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã¨åŒæ™‚æŽ¥ç¶š](#ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã¨åŒæ™‚æŽ¥ç¶š)
3. [500 ã‚¨ãƒ©ãƒ¼ã®åŽŸå› ã¨å¯¾ç­–](#500-ã‚¨ãƒ©ãƒ¼ã®åŽŸå› ã¨å¯¾ç­–)
4. [æŽ¨å¥¨è¨­å®šï¼ˆ.envï¼‰](#æŽ¨å¥¨è¨­å®šenv)
5. [ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †](#ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †)
6. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

---

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Windows ç’°å¢ƒã§ ScienceBuddy ã‚’å®Ÿè¡Œã—ã€**30 äººã®ç”Ÿå¾’ãŒåŒæ™‚ã«æ“ä½œã™ã‚‹å ´åˆ**ã®è¨­å®šã¨æœ€é©åŒ–æ–¹æ³•ã‚’èª¬æ˜Žã—ã¾ã™ã€‚

### ç’°å¢ƒæƒ…å ±
- **PC**: MacBook Airï¼ˆæ•™å¸«ç”¨ã€WiFi æŽ¥ç¶šï¼‰
- **äºˆæƒ³ç”Ÿå¾’æ•°**: 30 äººåŒæ™‚æŽ¥ç¶š
- **ngrok ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `https://sciencebuddy.ngrok.dev`
- **Web ã‚µãƒ¼ãƒ**: Waitressï¼ˆWSGIï¼‰

---

## ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã¨åŒæ™‚æŽ¥ç¶š

### ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã¨ã¯

Flask ã‚µãƒ¼ãƒãƒ¼ã®ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã¯ã€**åŒæ™‚ã«å‡¦ç†ã§ãã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°**ã«ç›´çµã—ã¾ã™ã€‚

```
Waitress ã‚¹ãƒ¬ãƒƒãƒ‰æ•° = æœ€å¤§åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆã‚­ãƒ¥ãƒ¼ãªã—ï¼‰

ä¾‹ï¼š
- ã‚¹ãƒ¬ãƒƒãƒ‰æ•° 4   â†’ æœ€å¤§ 4 äººãŒåŒæ™‚ã«ä¼šè©±ã§ãã‚‹
- ã‚¹ãƒ¬ãƒƒãƒ‰æ•° 15  â†’ æœ€å¤§ 15 äººãŒåŒæ™‚ã«ä¼šè©±ã§ãã‚‹
- ã‚¹ãƒ¬ãƒƒãƒ‰æ•° 30+ â†’ æœ€å¤§ 30+ äººãŒåŒæ™‚ã«ä¼šè©±ã§ãã‚‹
```

### 30 äººå¯¾å¿œã«å¿…è¦ãªã‚¹ãƒ¬ãƒƒãƒ‰æ•°

**æœ€å°**: 30 ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆ30 äººãŒåŒæ™‚ã«æ“ä½œã—ãŸå ´åˆï¼‰  
**æŽ¨å¥¨**: 40 ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆäºˆå‚™ãƒ»ä½™è£•ã‚’æŒã¤ãŸã‚ï¼‰

---

## 500 ã‚¨ãƒ©ãƒ¼ã®åŽŸå› ã¨å¯¾ç­–

### åŽŸå›  1ï¼šOpenAI API ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆæœ€ã‚‚é‡è¦ï¼‰

OpenAI API ã¯ 1 åˆ†é–“ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚

```
Free tier / Pay-as-you-go ä½Žã‚¹ãƒ”ãƒ¼ãƒ‰:
  â†’ æœ€å¤§ 3 ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/åˆ†

å®Ÿéš›ã®ã‚·ãƒŠãƒªã‚ªï¼ˆ30 äººãŒåŒæ™‚ã«ã€Œäºˆæƒ³ã‚’ã¾ã¨ã‚ã‚‹ã€ã‚’æŠ¼ã™ï¼‰:
  1. 30 å€‹ã® Flask ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ãŒ 30 å€‹å—ã‘ä»˜ã‘ã‚‹
  2. 30 å€‹ã® OpenAI API å‘¼ã³å‡ºã—ãŒä¸€åº¦ã«é£›ã¶
  3. OpenAI ãŒ 503 Service Unavailable ã‚’è¿”ã™
  4. Flask ãŒ 500 Internal Server Error ã«å¤‰æ› âŒ
```

### è§£æ±ºç­–ï¼šOpenAI ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼åŒ–ï¼ˆSemaphoreï¼‰

**ä¿®æ­£æ¸ˆã¿**: `app.py` ã« Semaphore ã‚’è¿½åŠ ã—ã¦ã€åŒæ™‚å®Ÿè¡Œæ•°ã‚’åˆ¶é™ã—ã¾ã—ãŸã€‚

```python
# .env ã‚ˆã‚Šå–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 3ï¼‰
OPENAI_CONCURRENT_LIMIT=3

# app.py ã§ Semaphore ã‚’ä½¿ç”¨
from threading import Semaphore
openai_request_semaphore = Semaphore(OPENAI_CONCURRENT_LIMIT)

# call_openai_with_retry() å†…ã§åˆ¶é™
with openai_request_semaphore:
    # OpenAI API ã‚’å‘¼ã³å‡ºã—
    return _call_openai_impl(...)
```

**åŠ¹æžœ**:
- 30 äººãŒåŒæ™‚ã«æ“ä½œã—ã¦ã‚‚ã€OpenAI API ã«ã¯æœ€å¤§ 3 å€‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã‹é£›ã°ãªã„
- æ®‹ã‚Šã¯ã‚­ãƒ¥ãƒ¼ã§å¾…æ©Ÿï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã¯ã€Œå°‘ã—é…ã„ã€ã«è¦‹ãˆã‚‹ï¼‰
- 500 ã‚¨ãƒ©ãƒ¼ãŒã»ã¼æ¶ˆãˆã‚‹ âœ…

### åŽŸå›  2ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

OpenAI API ãŒé…ã„å ´åˆã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§æŽ¥ç¶šãŒåˆ‡ã‚Œã¾ã™ã€‚

```
æ—§è¨­å®š: timeout=30ç§’
æ–°è¨­å®š: timeout=60ç§’ï¼ˆWiFi ç’°å¢ƒã§ã‚‚ååˆ†ï¼‰
```

### åŽŸå›  3ï¼šæŽ¥ç¶šãƒªã‚»ãƒƒãƒˆï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸å®‰å®šæ™‚ï¼‰

**ä¿®æ­£æ¸ˆã¿**: æŽ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šã‚’è¿½åŠ 

```env
URLLIB3_POOL_SIZE=30      # åŒæ™‚æŽ¥ç¶šæ•°
URLLIB3_MAX_RETRIES=5     # ãƒªãƒˆãƒ©ã‚¤å›žæ•°
SOCKET_KEEPALIVE=1        # TCP keepalive æœ‰åŠ¹
```

### åŽŸå›  4ï¼šãƒªãƒˆãƒ©ã‚¤ä¸è¶³

æ—§è¨­å®š: `max_retries=3`  
æ–°è¨­å®š: `max_retries=5`

---

## æŽ¨å¥¨è¨­å®šï¼ˆ.envï¼‰

```env
# =============================================
# åŸºæœ¬è¨­å®š
# =============================================
OPENAI_API_KEY=sk-proj-...ï¼ˆå®Ÿéš›ã®ã‚­ãƒ¼ï¼‰
GCP_PROJECT_ID=science-buddy-logs
GCS_BUCKET_NAME=production
FLASK_ENV=production
NGROK_URL=https://sciencebuddy.ngrok.dev

# =============================================
# ã‚¹ãƒ¬ãƒƒãƒ‰è¨­å®šï¼ˆ30 äººå¯¾å¿œï¼‰
# =============================================
WAITRESS_THREADS=40                    # 30 äººåŒæ™‚æŽ¥ç¶šå¯¾å¿œ
WAITRESS_CHANNEL_TIMEOUT=120          # æŽ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰

# =============================================
# OpenAI API è¨­å®š
# =============================================
OPENAI_API_TIMEOUT=60                 # API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
OPENAI_MAX_RETRIES=5                  # ãƒªãƒˆãƒ©ã‚¤å›žæ•°
OPENAI_RETRY_DELAY_BASE=3             # åŸºæœ¬å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰
OPENAI_CONCURRENT_LIMIT=3             # åŒæ™‚å®Ÿè¡Œæ•°åˆ¶é™ï¼ˆé‡è¦ï¼‰

# =============================================
# æŽ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š
# =============================================
URLLIB3_POOL_SIZE=30                  # åŒæ™‚æŽ¥ç¶šæ•°
URLLIB3_MAX_RETRIES=5                 # ãƒªãƒˆãƒ©ã‚¤å›žæ•°

# =============================================
# ã‚½ã‚±ãƒƒãƒˆè¨­å®š
# =============================================
SOCKET_KEEPALIVE=1                    # TCP keepalive
SOCKET_KEEPALIVE_INTERVAL=60          # keepalive é–“éš”ï¼ˆç§’ï¼‰

# =============================================
# ãƒ‡ãƒãƒƒã‚°
# =============================================
ENABLE_DEBUG_LOGGING=false            # true ãªã‚‰è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›
```

---

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³

```bash
git clone https://github.com/nov11masaki/scienceapp2.git
cd scienceapp2
```

### 2. ä»®æƒ³ç’°å¢ƒä½œæˆï¼ˆæŽ¨å¥¨ï¼‰

```bash
python -m venv .venv
source .venv/bin/activate  # macOS/Linux
# or
.venv\Scripts\activate  # Windows
```

### 3. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
pip install -r requirements.txt

# Waitress ãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆ
pip install waitress
```

### 4. .env è¨­å®šï¼ˆä¸Šè¨˜ã®æŽ¨å¥¨è¨­å®šã‚’ã‚³ãƒ”ãƒ¼ï¼‰

```bash
cat > .env << 'EOF'
OPENAI_API_KEY=sk-proj-...
FLASK_ENV=production
WAITRESS_THREADS=40
OPENAI_CONCURRENT_LIMIT=3
# ... ä»–ã®è¨­å®š
EOF
```

### 5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•

```bash
python app.py
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°å‡ºåŠ›**:
```
[INIT] OpenAI concurrent request limit set to: 3
[INIT] Starting ScienceBuddy with:
  - Port: 5014
  - Flask ENV: production
  - Threads: 40
  - Channel Timeout: 120s
  - ngrok URL: https://sciencebuddy.ngrok.dev
```

### 6. ngrok ãƒˆãƒ³ãƒãƒ«è¨­å®šï¼ˆç”Ÿå¾’ç”¨ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ï¼š

```bash
ngrok http 5014
```

ç”Ÿå¾’ã¯ä»¥ä¸‹ã® URL ã§ã‚¢ã‚¯ã‚»ã‚¹:
```
https://sciencebuddy.ngrok.dev
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ç—‡çŠ¶ 1ï¼šã¾ã  500 ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

**åŽŸå› ã®ç¢ºèª**:

1. **ãƒ­ã‚°ã‚’ç¢ºèª** (`ENABLE_DEBUG_LOGGING=true` ã«è¨­å®š)
   ```bash
   ENABLE_DEBUG_LOGGING=true python app.py
   ```

2. **OpenAI API ã‚­ãƒ¼ã‚’ç¢ºèª**
   ```bash
   echo $OPENAI_API_KEY
   ```

3. **OpenAI API ã®åˆ©ç”¨å¯èƒ½çŠ¶æ³ã‚’ç¢ºèª**
   - https://status.openai.com/

4. **ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ãŒè¶³ã‚Šã¦ã„ã‚‹ã‹ç¢ºèª**
   ```bash
   grep WAITRESS_THREADS .env
   # â†’ WAITRESS_THREADS=40 ä»¥ä¸Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
   ```

### ç—‡çŠ¶ 2ï¼šã€ŒæŽ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€ã‚¨ãƒ©ãƒ¼

**åŽŸå› **: OpenAI API ãŒé…ã„ã€ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒä¸å®‰å®š

**å¯¾ç­–**:
```env
OPENAI_API_TIMEOUT=90          # 60 â†’ 90 ç§’ã«å»¶é•·
OPENAI_MAX_RETRIES=7           # 5 â†’ 7 ã«å¢—åŠ 
```

### ç—‡çŠ¶ 3ï¼šã€ŒAPIåˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€ã‚¨ãƒ©ãƒ¼

**åŽŸå› **: OpenAI API ã® rate limit ã«é”ã—ã¦ã„ã‚‹

**å¯¾ç­–**:
```env
OPENAI_CONCURRENT_LIMIT=2      # 3 â†’ 2 ã«ä½Žä¸‹
# ã¾ãŸã¯
OPENAI_CONCURRENT_LIMIT=1      # å®Œå…¨ã«åŒæ™‚å®Ÿè¡Œã‚’ç¦æ­¢
```

**æ³¨æ„**: åŒæ™‚å®Ÿè¡Œæ•°ã‚’æ¸›ã‚‰ã™ã¨ã€å¿œç­”ãŒã‚ˆã‚Šé…ããªã‚Šã¾ã™ã€‚

### ç—‡çŠ¶ 4ï¼šãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šã„

**åŽŸå› **: ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ãŒå¤šã™ãŽã‚‹

**å¯¾ç­–**:
```env
WAITRESS_THREADS=20            # 40 â†’ 20 ã«å‰Šæ¸›ï¼ˆåŒæ™‚æŽ¥ç¶šæ•° 20 äººã¾ã§ï¼‰
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›®å®‰ï¼ˆå‚è€ƒå€¤ï¼‰

| åŒæ™‚æŽ¥ç¶šäººæ•° | æŽ¨å¥¨ã‚¹ãƒ¬ãƒƒãƒ‰æ•° | OpenAI åˆ¶é™ | å¿œç­”æ™‚é–“ |
|-------------|-------------|-----------|--------|
| 5-10 äºº | 10-15 | 3 | æ•°ç§’ |
| 10-20 äºº | 20-25 | 3 | æ•°ç§’ï½ž10ç§’ |
| 20-30 äºº | 30-40 | 3 | 10ç§’ï½ž30ç§’ |
| 30+ äºº | 40+ | 3 | 30ç§’ï½ž |

**OpenAI åˆ¶é™ 3** ã®å ´åˆã€åŒæ™‚æŽ¥ç¶šæ•°ãŒå¤šã„ã»ã©ã€1 äººå½“ãŸã‚Šã®å¿œç­”æ™‚é–“ãŒé•·ããªã‚Šã¾ã™ã€‚

---

## å‚è€ƒæƒ…å ±

### OpenAI API Rate Limits
- Free tier: 3 requests/min
- Pay-as-you-go: 500+ requests/minï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¨®åˆ¥ã«ã‚ˆã‚‹ï¼‰
- è©³ç´°: https://platform.openai.com/docs/guides/rate-limits

### Waitress ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- https://docs.pylonsproject.org/projects/waitress/en/stable/

### ngrok ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- https://ngrok.com/docs

---

## æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | å†…å®¹ |
|-----|------|
| 2025-12-02 | åˆç‰ˆä½œæˆã€‚30 äººåŒæ™‚æŽ¥ç¶šå¯¾å¿œãƒ»500 ã‚¨ãƒ©ãƒ¼è»½æ¸›è¨­å®š |

---

## è³ªå•ãƒ»å•é¡Œå ±å‘Š

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’åˆã‚ã›ã¦å ±å‘Šã—ã¦ãã ã•ã„ï¼š

1. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**ï¼ˆå®Œå…¨ãªãƒ†ã‚­ã‚¹ãƒˆï¼‰
2. **ãƒ­ã‚°**ï¼ˆENABLE_DEBUG_LOGGING=true æ™‚ã®å‡ºåŠ›ï¼‰
3. **ç’°å¢ƒå¤‰æ•°**ï¼ˆ.envï¼‰
4. **åŒæ™‚æŽ¥ç¶šäººæ•°**ï¼ˆå®Ÿéš›ã®ç”Ÿå¾’æ•°ï¼‰
5. **ä½¿ç”¨ãƒ–ãƒ©ã‚¦ã‚¶ãƒ»OS**

---

**Last updated**: 2025-12-02
