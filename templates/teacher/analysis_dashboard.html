{% extends "base.html" %}

{% block title %}äºˆæƒ³ãƒ»è€ƒå¯Ÿåˆ†æ{% endblock %}

{% block content %}
<div class="analysis-dashboard-page">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="analysis-header">
        <div class="header-container">
            <h1><i class="fas fa-microscope"></i> äºˆæƒ³ãƒ»è€ƒå¯Ÿåˆ†æ</h1>
            <p>å…ç«¥ã®äºˆæƒ³ã‚„é–¢ä¿‚ä»˜ã‘ã®å‚¾å‘ã‚’åˆ†æã—ã¾ã™</p>
        </div>
    </header>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="analysis-filters">
        <div class="filter-group">
            <label for="unitSelect">å˜å…ƒé¸æŠ:</label>
            <select id="unitSelect">
                <option value="">å…¨å˜å…ƒ</option>
                {% for unit in units %}
                <option value="{{ unit }}">{{ unit }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="dateInput">æ—¥ä»˜:</label>
            <input type="date" id="dateInput" />
        </div>
        <button onclick="loadAnalysis()" class="btn btn-primary">åˆ†æã‚’èª­ã¿è¾¼ã‚€</button>
    </section>

    <!-- åˆ†æçµæœ -->
    <section class="analysis-results">
        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-comments"></i></div>
                <div class="stat-content">
                    <h3>ç·å¯¾è©±æ•°</h3>
                    <p id="totalChats">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-lightbulb"></i></div>
                <div class="stat-content">
                    <h3>äºˆæƒ³ãƒãƒ£ãƒƒãƒˆ</h3>
                    <p id="predictionCount">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                <div class="stat-content">
                    <h3>è€ƒå¯Ÿãƒãƒ£ãƒƒãƒˆ</h3>
                    <p id="reflectionCount">0</p>
                </div>
            </div>
        </div>

        <!-- å˜å…ƒåˆ¥åˆ†æ -->
        <div class="analysis-content">
            <!-- äºˆæƒ³æ®µéšã®åˆ†æ -->
            <div class="analysis-section">
                <h2><i class="fas fa-lightbulb"></i> äºˆæƒ³æ®µéšã®åˆ†æ</h2>
                <div id="predictionAnalysis" class="unit-analysis-container">
                    <!-- å˜å…ƒã”ã¨ã®åˆ†æãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>

            <!-- è€ƒå¯Ÿæ®µéšã®åˆ†æ -->
            <div class="analysis-section">
                <h2><i class="fas fa-graduation-cap"></i> è€ƒå¯Ÿæ®µéšã®åˆ†æ</h2>
                <div id="reflectionAnalysis" class="unit-analysis-container">
                    <!-- å˜å…ƒã”ã¨ã®åˆ†æãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </section>

    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <div class="actions-section">
        <a href="/teacher/dashboard" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æœ¬æ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
    const today = new Date().toISOString().slice(0, 10);
    document.getElementById('dateInput').value = today;
});

// åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
function loadAnalysis() {
    const unit = document.getElementById('unitSelect').value;
    const date = document.getElementById('dateInput').value;

    if (!date) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    // æ—¥ä»˜ã‚’YYYYMMDDå½¢å¼ã«å¤‰æ›
    const formattedDate = date.replace(/-/g, '');

    fetch(`/teacher/analysis?date=${formattedDate}&unit=${unit}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAnalysis(data.analysis);
            } else {
                alert('åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        });
}

// åˆ†æçµæœã‚’è¡¨ç¤º
function displayAnalysis(analysis) {
    // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
    document.getElementById('totalChats').textContent = analysis.total_logs;
    document.getElementById('predictionCount').textContent = analysis.prediction_chats;
    document.getElementById('reflectionCount').textContent = analysis.reflection_chats;

    // äºˆæƒ³æ®µéšã®åˆ†æã‚’è¡¨ç¤º
    displayPredictionAnalysis(analysis.predictions_by_unit, analysis.text_analysis);

    // è€ƒå¯Ÿæ®µéšã®åˆ†æã‚’è¡¨ç¤º
    displayReflectionAnalysis(analysis.reflections_by_unit, analysis.text_analysis);
}

// äºˆæƒ³æ®µéšã®åˆ†æã‚’è¡¨ç¤º
function displayPredictionAnalysis(predictionsByUnit, textAnalysis) {
    const container = document.getElementById('predictionAnalysis');
    container.innerHTML = '';

    if (Object.keys(predictionsByUnit).length === 0) {
        container.innerHTML = '<p class="no-data">äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    for (const [unit, predictions] of Object.entries(predictionsByUnit)) {
        const unitAnalysis = textAnalysis[unit]?.prediction || {};
        const html = `
            <div class="unit-analysis">
                <h3>${unit}</h3>
                <div class="analysis-metrics">
                    <div class="metric">
                        <label>å¯¾è©±æ•°:</label>
                        <span>${predictions.length}</span>
                    </div>
                    <div class="metric">
                        <label>å¹³å‡æ–‡å­—æ•°:</label>
                        <span>${Math.round(unitAnalysis.average_length || 0)}</span>
                    </div>
                    <div class="metric">
                        <label>æœ€å¤§æ–‡å­—æ•°:</label>
                        <span>${unitAnalysis.max_length || 0}</span>
                    </div>
                </div>
                <div class="keywords-section">
                    <h4>é »å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</h4>
                    <div class="keywords-list">
                        ${(unitAnalysis.keywords || []).map(kw =>
                            `<span class="keyword-tag">${kw.word} <small>(${kw.count})</small></span>`
                        ).join('')}
                    </div>
                </div>
                <div class="patterns-section">
                    <h4>è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³:</h4>
                    <ul class="patterns-list">
                        <li>äºˆæƒ³è¡¨ç¾: ${unitAnalysis.patterns?.prediction_expressions || 0}å›</li>
                        <li>å› æœè¡¨ç¾: ${unitAnalysis.patterns?.causal_expressions || 0}å›</li>
                        <li>æ¯”è¼ƒè¡¨ç¾: ${unitAnalysis.patterns?.comparison_expressions || 0}å›</li>
                        <li>çµŒé¨“å‚ç…§: ${unitAnalysis.patterns?.experience_references || 0}å›</li>
                        <li>ä¸ç¢ºå®Ÿæ€§è¡¨ç¾: ${unitAnalysis.patterns?.uncertainty_expressions || 0}å›</li>
                    </ul>
                </div>
                <details class="sample-messages">
                    <summary>ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹</summary>
                    <div class="messages-list">
                        ${predictions.slice(0, 5).map(p => `
                            <div class="message-item">
                                <div class="message-student">${p.student}</div>
                                <div class="message-text">
                                    <strong>å…ç«¥:</strong> ${escapeHtml(p.user_message)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            </div>
        `;
        container.innerHTML += html;
    }
}

// è€ƒå¯Ÿæ®µéšã®åˆ†æã‚’è¡¨ç¤º
function displayReflectionAnalysis(reflectionsByUnit, textAnalysis) {
    const container = document.getElementById('reflectionAnalysis');
    container.innerHTML = '';

    if (Object.keys(reflectionsByUnit).length === 0) {
        container.innerHTML = '<p class="no-data">è€ƒå¯Ÿãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }

    for (const [unit, reflections] of Object.entries(reflectionsByUnit)) {
        const unitAnalysis = textAnalysis[unit]?.reflection || {};
        const html = `
            <div class="unit-analysis">
                <h3>${unit}</h3>
                <div class="analysis-metrics">
                    <div class="metric">
                        <label>å¯¾è©±æ•°:</label>
                        <span>${reflections.length}</span>
                    </div>
                    <div class="metric">
                        <label>å¹³å‡æ–‡å­—æ•°:</label>
                        <span>${Math.round(unitAnalysis.average_length || 0)}</span>
                    </div>
                    <div class="metric">
                        <label>æœ€å¤§æ–‡å­—æ•°:</label>
                        <span>${unitAnalysis.max_length || 0}</span>
                    </div>
                </div>
                <div class="keywords-section">
                    <h4>é »å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</h4>
                    <div class="keywords-list">
                        ${(unitAnalysis.keywords || []).map(kw =>
                            `<span class="keyword-tag">${kw.word} <small>(${kw.count})</small></span>`
                        ).join('')}
                    </div>
                </div>
                <div class="patterns-section">
                    <h4>è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³:</h4>
                    <ul class="patterns-list">
                        <li>äºˆæƒ³è¡¨ç¾: ${unitAnalysis.patterns?.prediction_expressions || 0}å›</li>
                        <li>å› æœè¡¨ç¾: ${unitAnalysis.patterns?.causal_expressions || 0}å›</li>
                        <li>æ¯”è¼ƒè¡¨ç¾: ${unitAnalysis.patterns?.comparison_expressions || 0}å›</li>
                        <li>çµŒé¨“å‚ç…§: ${unitAnalysis.patterns?.experience_references || 0}å›</li>
                        <li>ä¸ç¢ºå®Ÿæ€§è¡¨ç¾: ${unitAnalysis.patterns?.uncertainty_expressions || 0}å›</li>
                    </ul>
                </div>
                <details class="sample-messages">
                    <summary>ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã‚‹</summary>
                    <div class="messages-list">
                        ${reflections.slice(0, 5).map(r => `
                            <div class="message-item">
                                <div class="message-student">${r.student}</div>
                                <div class="message-text">
                                    <strong>å…ç«¥:</strong> ${escapeHtml(r.user_message)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            </div>
        `;
        container.innerHTML += html;
    }
}

// HTMLç‰¹æ®Šæ–‡å­—ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<style>
.analysis-dashboard-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.analysis-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    text-align: center;
}

.analysis-header h1 {
    font-size: 2rem;
    margin: 0 0 10px 0;
}

.analysis-header p {
    margin: 0;
    opacity: 0.9;
}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.analysis-filters {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    flex-wrap: wrap;
    align-items: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-weight: 600;
    font-size: 0.9rem;
}

.filter-group select,
.filter-group input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
}

/* çµ±è¨ˆæƒ…å ± */
.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    font-size: 2rem;
    color: #667eea;
}

.stat-content h3 {
    margin: 0 0 5px 0;
    font-size: 0.9rem;
    color: #666;
}

.stat-content p {
    margin: 0;
    font-size: 2rem;
    font-weight: bold;
    color: #333;
}

/* åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.analysis-section {
    margin-bottom: 30px;
}

.analysis-section h2 {
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.unit-analysis-container {
    display: grid;
    gap: 20px;
}

.unit-analysis {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #667eea;
}

.unit-analysis h3 {
    margin-top: 0;
    color: #667eea;
}

/* ãƒ¡ãƒˆãƒªã‚¯ã‚¹ */
.analysis-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.metric {
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
}

.metric label {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 5px;
}

.metric span {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}

/* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ */
.keywords-section h4,
.patterns-section h4 {
    margin: 15px 0 10px 0;
    color: #333;
}

.keywords-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.keyword-tag {
    background: #667eea;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
}

.keyword-tag small {
    margin-left: 4px;
    opacity: 0.8;
}

/* ãƒ‘ã‚¿ãƒ¼ãƒ³ */
.patterns-list {
    list-style: none;
    padding: 0;
    margin: 10px 0;
}

.patterns-list li {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
}

.patterns-list li:last-child {
    border-bottom: none;
}

/* ã‚µãƒ³ãƒ—ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.sample-messages {
    margin-top: 15px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 4px;
    cursor: pointer;
}

.sample-messages summary {
    font-weight: 600;
    color: #667eea;
}

.messages-list {
    margin-top: 15px;
    max-height: 300px;
    overflow-y: auto;
}

.message-item {
    padding: 10px;
    background: white;
    border-radius: 4px;
    margin-bottom: 10px;
    border-left: 3px solid #667eea;
}

.message-student {
    font-size: 0.8rem;
    color: #999;
    margin-bottom: 5px;
}

.message-text {
    font-size: 0.9rem;
    line-height: 1.5;
    word-break: break-word;
}

/* ãã®ä»– */
.no-data {
    text-align: center;
    padding: 30px;
    color: #999;
    background: #f9f9f9;
    border-radius: 4px;
}

.actions-section {
    text-align: center;
    margin-top: 30px;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 4px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    border: none;
    font-size: 1rem;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}
</style>
{% endblock %}
