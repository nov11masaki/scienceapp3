{% extends "base.html" %}

{% block title %}å­¦ç¿’ãƒ­ã‚°ä¸€è¦§{% endblock %}

{% block content %}
<div class="teacher-logs">
    <div class="container">
        <div class="logs-header mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">
                    <i class="fas fa-clipboard-list text-primary"></i>
                    å­¦ç¿’ãƒ­ã‚°ä¸€è¦§
                </h2>
                <div class="teacher-info">
                    <span class="badge bg-success me-2">{{ teacher_id }}</span>
                    <a href="/teacher/logout" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </a>
                </div>
            </div>
            
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="filters-section mb-4">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">æ—¥ä»˜</label>
                        <select class="form-select" id="dateFilter" title="æ—¥ä»˜ã§çµã‚Šè¾¼ã‚€" onchange="applyFilters()">
                            {% for date_info in available_dates %}
                            <option value="{{ date_info.raw }}" {% if current_date == date_info.raw %}selected{% endif %}>
                                {{ date_info.formatted }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">å˜å…ƒ</label>
                        <select class="form-select" id="unitFilter" title="å˜å…ƒã§çµã‚Šè¾¼ã‚€" onchange="applyFilters()">
                            <option value="">ã™ã¹ã¦ã®å˜å…ƒ</option>
                            {% for unit in units %}
                            <option value="{{ unit }}" {% if current_unit == unit %}selected{% endif %}>
                                {{ unit }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ã‚¯ãƒ©ã‚¹</label>
                        <select class="form-control" id="classFilter" title="ã‚¯ãƒ©ã‚¹ã§çµã‚Šè¾¼ã‚€" onchange="applyFilters()">
                            <option value="">å…¨ã¦</option>
                            <option value="1" {% if current_class == '1' %}selected{% endif %}>1çµ„</option>
                            <option value="2" {% if current_class == '2' %}selected{% endif %}>2çµ„</option>
                            <option value="3" {% if current_class == '3' %}selected{% endif %}>3çµ„</option>
                            <option value="4" {% if current_class == '4' %}selected{% endif %}>4çµ„</option>
                            <option value="5" {% if current_class == '5' %}selected{% endif %}>5çµ„</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">å‡ºå¸­ç•ªå·</label>
                        <input type="number" class="form-control" id="studentFilter" 
                               placeholder="å‡ºå¸­ç•ªå·" min="1" max="30"
                               value="{{ current_student }}" onchange="applyFilters()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-eraser me-2"></i>ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å…ç«¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
        {% if students_data %}
        <div class="students-grid">
            {% for student_number, student_data in students_data.items() %}
            <div class="student-card">
                {% set student_info = student_data.student_info %}
                {% set class_num = student_info.class_num if student_info else None %}
                {% set seat_num = student_info.seat_num if student_info else None %}
                <div class="student-header">
                    <h4>
                        <i class="fas fa-user-graduate"></i>
                        {% if class_num is not none and seat_num is not none %}
                            {{ class_num }}çµ„ {{ seat_num }}ç•ª
                            <span class="student-id-badge">ID: {{ student_number }}</span>
                        {% else %}
                            ID: {{ student_number }}
                            {% if student_info and student_info.display %}
                                <span class="student-id-badge">{{ student_info.display }}</span>
                            {% else %}
                                <span class="student-id-badge">ã‚¯ãƒ©ã‚¹æƒ…å ±ãªã—</span>
                            {% endif %}
                        {% endif %}
                    </h4>
                    {% if student_info and student_info.display %}
                        <div class="student-sub-info text-muted small">{{ student_info.display }}</div>
                    {% endif %}
                </div>
                
                <div class="units-list">
                    {% for unit_name, unit_data in student_data.units.items() %}
                    <div class="unit-item">
                        <div class="unit-header">
                            <h6 class="unit-name">{{ unit_name }}</h6>
                            <div class="progress-indicators">
                                {% if unit_data.prediction_chats %}
                                    <span class="badge bg-info" title="äºˆæƒ³å¯¾è©±">
                                        <i class="fas fa-comments"></i> {{ unit_data.prediction_chats|length }}
                                    </span>
                                {% endif %}
                                {% if unit_data.prediction_summary %}
                                    <span class="badge bg-primary" title="äºˆæƒ³ã¾ã¨ã‚">
                                        <i class="fas fa-brain"></i>
                                    </span>
                                {% endif %}
                                {% if unit_data.reflection_chats %}
                                    <span class="badge bg-warning" title="è€ƒå¯Ÿå¯¾è©±">
                                        <i class="fas fa-lightbulb"></i> {{ unit_data.reflection_chats|length }}
                                    </span>
                                {% endif %}
                                {% if unit_data.final_summary %}
                                    <span class="badge bg-success" title="æœ€çµ‚è€ƒå¯Ÿ">
                                        <i class="fas fa-check"></i>
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="unit-actions">
                            <a href="/teacher/student_detail?class={{ class_num }}&seat={{ seat_num }}&unit={{ unit_name|urlencode }}&date={{ current_date }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> è©³ç´°
                            </a>
                        </div>
                        
                        <!-- äºˆæƒ³ã¾ã¨ã‚ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º -->
                        {% if unit_data.prediction_summary %}
                        <div class="summary-preview">
                            <small class="text-muted">äºˆæƒ³:</small>
                            <p class="mb-1">{{ unit_data.prediction_summary.data.summary[:100] }}
                            {% if unit_data.prediction_summary.data.summary|length > 100 %}...{% endif %}</p>
                        </div>
                        {% endif %}
                        
                        <!-- æœ€çµ‚è€ƒå¯ŸãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º -->
                        {% if unit_data.final_summary %}
                        <div class="summary-preview">
                            <small class="text-muted">è€ƒå¯Ÿ:</small>
                            <p class="mb-0">{{ unit_data.final_summary.data.final_summary[:100] }}
                            {% if unit_data.final_summary.data.final_summary|length > 100 %}...{% endif %}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h4>
            <p class="text-muted">æŒ‡å®šã—ãŸæ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å­¦ç¿’ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        {% endif %}
        
        <div class="text-center mt-5">
            <a href="/teacher/dashboard" class="btn btn-outline-secondary me-3">
                <i class="fas fa-arrow-left me-2"></i>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
            </a>
            <div class="d-inline-block">
                <button class="btn btn-success me-2" onclick="exportCurrentData('csv')">
                    <i class="fas fa-file-csv me-2"></i>CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
                <button class="btn btn-primary" onclick="exportCurrentData('json')">
                    <i class="fas fa-file-archive me-2"></i>JSONã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (zip)
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
    let url = '/teacher/logs?';
    const params = [];
    
    const date = document.getElementById('dateFilter').value;
    const unit = document.getElementById('unitFilter').value;
    const classNum = document.getElementById('classFilter').value;
    const student = document.getElementById('studentFilter').value;
    
    if (date) params.push(`date=${date}`);
    if (unit) params.push(`unit=${encodeURIComponent(unit)}`);
    if (classNum) params.push(`class=${classNum}`);
    if (student) params.push(`student=${student}`);
    
    url += params.join('&');
    window.location.href = url;
}

function clearFilters() {
    const dateSelect = document.getElementById('dateFilter');
    if (dateSelect.options.length > 0) {
        dateSelect.selectedIndex = 0;
    }
    document.getElementById('unitFilter').value = '';
    document.getElementById('classFilter').value = '';
    document.getElementById('studentFilter').value = '';
    applyFilters();
}

function exportCurrentData(format) {
    // format: 'csv' or 'json'
    format = format || 'csv';
    const date = document.getElementById('dateFilter').value;
    const unit = encodeURIComponent(document.getElementById('unitFilter').value || '');
    const classNum = encodeURIComponent(document.getElementById('classFilter').value || '');
    const student = encodeURIComponent(document.getElementById('studentFilter').value || '');

    let exportUrl = '';
    if (format === 'json') {
        exportUrl = `/teacher/export_json?date=${date}&unit=${unit}&class=${classNum}&student=${student}`;
    } else {
        exportUrl = `/teacher/export?date=${date}&unit=${unit}&class=${classNum}&student=${student}`;
    }

    // fetch ã—ã¦ Blob ã‚’ä½œã‚Šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æ–¹å¼ã«å¤‰æ›´
    fetch(exportUrl, { credentials: 'include' })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        // ãƒ­ã‚°ã‚¤ãƒ³åˆ‡ã‚Œã‚„ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãªã„
        const contentType = response.headers.get('Content-Type') || '';
        if (contentType.includes('text/html')) {
            throw new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ Content-Disposition ã‹ã‚‰å–ã‚Šå‡ºã™ï¼ˆãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        const cd = response.headers.get('Content-Disposition') || '';
        let filename = '';
        const utf8Match = cd.match(/filename\*=\s*UTF-8''([^;"\n]+)/i);
        const plainMatch = cd.match(/filename="?([^;"\n]+)"?/i);
        if (utf8Match && utf8Match[1]) {
            filename = decodeURIComponent(utf8Match[1]);
        } else if (plainMatch && plainMatch[1]) {
            filename = plainMatch[1];
        } else {
            const ext = format === 'json' ? 'zip' : 'csv';
            filename = `learning_logs_${date}.${ext}`;
        }
        return response.blob().then(blob => ({ blob, filename }));
    })
    .then(({ blob, filename }) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setTimeout(() => {
            alert(`ğŸ“¥ ${date} ã®ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ (${format.toUpperCase()})ã€‚`);
        }, 300);
    })
    .catch(err => {
        console.error('Export fetch error', err);
        alert(err.message || 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        // fetch ãŒå¤±æ•—ã—ãŸå ´åˆã‚‚é€šå¸¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        try {
            window.location.href = exportUrl;
        } catch (e) {
            console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚‚å¤±æ•—:', e);
        }
    });
}


</script>
{% endblock %}
